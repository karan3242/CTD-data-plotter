---
title: "Water column Data"
output: html_document
runtime: shiny
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shiny)
library(ggplot2)
library(readxl)
library(dplyr)
library(tidyverse)
library(ggsci)

# Define the directory where your Excel files are stored
data_folder <- "data"

# List all .xlsx files in the data folder
xlsx_files <- list.files(path = data_folder, pattern = "\\.xlsx$", full.names = TRUE)

# Extract file names without extension
file_names <- tools::file_path_sans_ext(basename(xlsx_files))

# Variable options for the plot
var <- c("Sal00", "Tv290C", "FlSP", "SeaTurbMtr", "Par", "Sbeox0Mm/L", "Sbeox0PS")
```

```{r}
# Shiny controls for file and variable selection
# Select files and variables for the plot
shiny::fluidPage(
  selectInput(
    "fileSelect",
    "Select file:",
    choices = file_names,
    multiple = TRUE
  ),
  shiny::checkboxGroupInput(
    "varSelect",
    "Select variables:",
    choices = var,
    inline = TRUE
  )
)
```

```{r}
shiny::renderPlot({
  # Ensure selections are made
  req(input$fileSelect, input$varSelect)
  
  # Read and combine data from selected files, adding a "File" column
  combined_data <- bind_rows(lapply(input$fileSelect, function(file) {
    path <- file.path(data_folder, paste0(file, ".xlsx"))
    read_excel(path) %>%
      drop_na() %>%
      mutate(File = file)  # Add a column for the source file
  }))
  
  # Reshape data to long format for multi-variable plotting
  long_data <- combined_data %>%
    pivot_longer(cols = input$varSelect,
                 names_to = "Variable",
                 values_to = "Value")
  
  # Create a unique identifier for color grouping using both File and Variable
  long_data <- long_data %>%
    mutate(FileVariable = paste(File, Variable, sep = " - "))
  
  # Create the plot with ggplot, using `FileVariable` for color grouping
  ggplot(long_data, aes(x = DepSM, y = Value, color = FileVariable)) +
    geom_line() +
    scale_x_reverse() +
    coord_flip() +
    facet_wrap( ~ Variable, scales = "free") +
    ggtitle("Multi-File Variable Plot") +
    xlab("Depth(m)") +
    theme_minimal() +
    theme(legend.title = element_blank())+
    scale_color_uchicago()
}, width = "auto", height = 1080)
```
