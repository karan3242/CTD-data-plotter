---
title: "Water column Data"
output: html_document
runtime: shiny
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shiny)
library(ggplot2)
library(readxl)
library(dplyr)
library(tidyverse)
library(ggsci)

# Define the directory where your Excel files are stored
data_folder <- "data"

# List all .xlsx files in the data folder
xlsx_files <- list.files(path = data_folder, pattern = "\\.xlsx$", full.names = TRUE)

# Extract file names without extension
file_names <- tools::file_path_sans_ext(basename(xlsx_files))

# Variable options for the plot
var <- c("Sal00", "Tv290C", "FlSP", "SeaTurbMtr", "Par", "Sbeox0Mm/L", "Sbeox0PS", "AltM", "Flag")
```

```{r}
# Shiny controls for file and variable selection
# Select files and variables for the plot
shiny::fluidPage(
  selectInput(
    "fileSelect",
    "Select file:",
    choices = file_names,
    multiple = TRUE
  ),
  shiny::checkboxGroupInput(
    "varSelect",
    "Select variables:",
    choices = var,
    inline = TRUE,
    selected = "FlSP"
  )
)
```

```{r}
shiny::renderPlot({
  # Ensure selections are made
  req(input$fileSelect, input$varSelect)
  
  # Read and combine data from selected files, adding a "File" column
  combined_data <- bind_rows(lapply(input$fileSelect, function(file) {
    path <- file.path(data_folder, paste0(file, ".xlsx"))
    read_excel(path) %>%
      drop_na() %>% # removes NA row if any
      mutate(File = file)  # Add a column for the source file
  }))
  
  # Reshape data to long format for multi-variable plotting
  long_data <- combined_data %>%
    pivot_longer(cols = input$varSelect,
                 names_to = "Variable",
                 values_to = "Value")
  
  # Create a unique identifier for color grouping using both File and Variable
  long_data <- long_data %>%
    mutate(FileVariable = paste(File, Variable, sep = " - "))
  
  # Create the plot with ggplot, using `FileVariable` for color grouping
  ggplot(long_data, aes(x = DepSM, y = Value, color = FileVariable)) +
   # geom_line() + # Geom Line
    geom_smooth(se = FALSE, method = "gam")+ #gome Smooth with Gam method.
    coord_flip() + # Rotate the plot to have X axis Vertical
    scale_x_reverse() + # Reverse the x axis to have 0 at top
    facet_wrap( ~ Variable, scales = "free") + # Each Variable gets its own plot
    # ggtitle("Multi-File Variable Plot") + # Title for the Plot
    xlab("Depth(m)") + # X axis Label
    theme_minimal() + # Theme of plot
    scale_color_uchicago() + # Color Palet
    theme(legend.title = element_blank(),
          legend.position = "bottom") # Legend
}, 
width = "auto", # Plot width
height = 1080) # Plot height
```
